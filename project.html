<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Select Project Code</title>
  <style>
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
    }

    th, td {
      border: 1px solid #aaa;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #f2f2f2;
    }

    td:hover {
      background-color: #eef;
    }

    .clickable-cell {
      cursor: pointer;
      background-color: #fefefe;
    }

    .clickable-cell:hover {
      background-color: #cce6ff;
    }
  </style>
</head>
<body>
  <h2>Select a Project Code</h2>

  <select id="projectDropdown" onchange="handleSelection()">
    <option value="">Loading...</option>
  </select>

  <p>Selected Project Code: <span id="selectedCode">None</span></p>

  <div id="recordsContainer"></div>

  <script>
    // Fetch available project codes for dropdown
    async function fetchProjectCodes() {
      const dropdown = document.getElementById('projectDropdown');
      dropdown.innerHTML = `<option>Loading...</option>`;

      try {
        const response = await fetch('/api/get-projects');
        const data = await response.json();

        dropdown.innerHTML = `<option value="">-- Select --</option>`;
        data.projectCodes.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          dropdown.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to fetch project codes:', err);
        dropdown.innerHTML = `<option>Error loading data</option>`;
      }
    }

    // Handle dropdown selection
    function handleSelection() {
      const selected = document.getElementById('projectDropdown').value;
      document.getElementById('selectedCode').textContent = selected || 'None';

      if (selected) {
        fetchRecordsForProject(selected);
      } else {
        document.getElementById('recordsContainer').innerHTML = '';
      }
    }

    // Fetch and render pivot table
    async function fetchRecordsForProject(projectCode) {
      const container = document.getElementById('recordsContainer');
      container.innerHTML = 'Loading records...';

      try {
        const response = await fetch(`/api/get-records?projectCode=${encodeURIComponent(projectCode)}`);
        const data = await response.json();

        if (!data.records || data.records.length === 0) {
          container.innerHTML = 'No records found for this project.';
          return;
        }

        // Step 1: Build pivot data
        const pivot = {};
        const designations = new Set();
        const weekLabels = new Set();

        data.records.forEach(record => {
          const f = record.fields;
          const designation = f["Designation"];
          const weekLabel = f["Week Label"];
          const req = f["Requirement Count"];
          const work = f["Working Count"];

          designations.add(designation);
          weekLabels.add(weekLabel);

          if (!pivot[designation]) pivot[designation] = {};
          pivot[designation][weekLabel] = `Required = ${req} Working = ${work}`;
        });

        const sortedWeekLabels = Array.from(weekLabels).sort();
        const sortedDesignations = Array.from(designations).sort();

        // Step 2: Build HTML table
        let html = `<table>
                      <thead>
                        <tr>
                          <th>Designation</th>`;
        sortedWeekLabels.forEach(week => {
          html += `<th>${week}</th>`;
        });
        html += `</tr></thead><tbody>`;

        sortedDesignations.forEach(designation => {
          // Encode the designation safely and store in a data attribute
          const desigEncoded = encodeURIComponent(designation);
          html += `<tr data-designation="${desigEncoded}">`;
          html += `<td><strong>${designation}</strong></td>`;

          sortedWeekLabels.forEach(week => {
            const cellContent = pivot[designation][week] || '';
            html += `<td class="clickable-cell">${cellContent}</td>`;
          });

          html += `</tr>`;
        });

        html += `</tbody></table>`;
        container.innerHTML = html;

        // Attach click events to each cell
        const cells = document.querySelectorAll('.clickable-cell');
        cells.forEach(cell => {
          cell.addEventListener('click', function () {
            const row = cell.closest('tr');
            const desig = row.getAttribute('data-designation'); // already URL-encoded
            const projcodeRaw = document.getElementById('projectDropdown').value;
            const projcode = encodeURIComponent(projcodeRaw);

            if (!projcode || !desig) {
              alert('Missing project code or designation');
              return;
            }

            const url = `requirement-form.html?projcode=${projcode}&desig=${desig}`;
            window.open(url, '_blank');
          });
        });

      } catch (error) {
        console.error('Error fetching records:', error);
        container.innerHTML = 'Failed to load records.';
      }
    }

    // Initialize on load
    fetchProjectCodes();
  </script>
</body>
</html>
