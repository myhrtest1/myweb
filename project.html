<!DOCTYPE html>
<html>
<head>
  <title>Select Project Code</title>
</head>
<body>
  <h2>Select a Project Code</h2>

  <select id="projectDropdown" onchange="handleSelection()">
    <option value="">Loading...</option>
  </select>

  <p>Selected Project Code: <span id="selectedCode">None</span></p>

  <!-- ðŸ”½ This is where the filtered records will be displayed -->
  <div id="recordsContainer" style="margin-top: 20px;"></div>

  <script>
    async function fetchProjectCodes() {
      const dropdown = document.getElementById('projectDropdown');
      dropdown.innerHTML = `<option>Loading...</option>`;

      try {
        const response = await fetch('/api/get-projects');
        const data = await response.json();

        dropdown.innerHTML = `<option value="">-- Select --</option>`;
        data.projectCodes.forEach(code => {
          const option = document.createElement('option');
          option.value = code;
          option.textContent = code;
          dropdown.appendChild(option);
        });
      } catch (err) {
        console.error('Failed to fetch project codes:', err);
        dropdown.innerHTML = `<option>Error loading data</option>`;
      }
    }

    async function fetchRecordsForProject(projectCode) {
      const container = document.getElementById('recordsContainer');
      container.innerHTML = 'Loading records...';

      try {
        const response = await fetch(`/api/get-records?projectCode=${encodeURIComponent(projectCode)}`);
        const data = await response.json();

        if (!data.records || data.records.length === 0) {
          container.innerHTML = 'No records found for this project.';
          return;
        }

        let html = '<ul>';
        data.records.forEach(record => {
          html += `<li>${JSON.stringify(record.fields)}</li>`;
        });
        html += '</ul>';

        container.innerHTML = html;
      } catch (error) {
        console.error('Error fetching records:', error);
        container.innerHTML = 'Failed to load records.';
      }
    }

    function handleSelection() {
      const selected = document.getElementById('projectDropdown').value;
      document.getElementById('selectedCode').textContent = selected || 'None';

      if (selected) {
        fetchRecordsForProject(selected);
      } else {
        document.getElementById('recordsContainer').innerHTML = '';
      }
    }

    fetchProjectCodes();
  </script>
</body>
</html>
