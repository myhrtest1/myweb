<!DOCTYPE html>
<html>
<head>
  <title>Select Project Code</title>
</head>
<body>
  <h2>Select a Project Code</h2>

  <select id="projectDropdown" onchange="handleSelection()">
    <option value="">Loading...</option>
  </select>

<script>
  async function fetchRecordsForProject(projectCode) {
    const container = document.getElementById('recordsContainer');
    container.innerHTML = 'Loading records...';

    try {
      const response = await fetch(`/api/get-records?projectCode=${encodeURIComponent(projectCode)}`);
      const data = await response.json();

      if (!data.records || data.records.length === 0) {
        container.innerHTML = 'No records found for this project.';
        return;
      }

      // Step 1: Build pivot data and collect unique Week Labels and Designations
      const pivot = {}; // { Designation: { WeekLabel: 'Required = X Working = Y' } }
      const designations = new Set();
      const weekLabels = new Set();

      data.records.forEach(record => {
        const f = record.fields;
        const designation = f["Designation"];
        const weekLabel = f["Week Label"];
        const req = f["Requirement Count"];
        const work = f["Working Count"];

        designations.add(designation);
        weekLabels.add(weekLabel);

        if (!pivot[designation]) pivot[designation] = {};
        pivot[designation][weekLabel] = `Required = ${req} Working = ${work}`;
      });

      // Step 2: Sort week labels and designations for consistent order
      const sortedWeekLabels = Array.from(weekLabels).sort();
      const sortedDesignations = Array.from(designations).sort();

      // Step 3: Build HTML table
      let html = `<table border="1" cellpadding="6" cellspacing="0">
        <thead>
          <tr>
            <th>Designation</th>`;

      sortedWeekLabels.forEach(week => {
        html += `<th>${week}</th>`;
      });

      html += `</tr></thead><tbody>`;

      sortedDesignations.forEach(designation => {
        html += `<tr><td><strong>${designation}</strong></td>`;
        sortedWeekLabels.forEach(week => {
          const cell = pivot[designation][week];
          html += `<td>${cell}</td>`;
        });
        html += `</tr>`;
      });

      html += `</tbody></table>`;
      container.innerHTML = html;

    } catch (error) {
      console.error('Error fetching records:', error);
      container.innerHTML = 'Failed to load records.';
    }
  }
</script>

</body>
</html>
